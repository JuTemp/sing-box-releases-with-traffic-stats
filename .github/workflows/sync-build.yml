name: Sync Build from Upstream

on:
  schedule:
    - cron: '12 */2 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Upstream Latest Release
        id: upstream
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          UPSTREAM="SagerNet/sing-box"

          RELEASE_DATA=$(gh api repos/$UPSTREAM/releases --jq '.[0]')
          
          TAG_NAME=$(echo "$RELEASE_DATA" | jq -r '.tag_name')
          IS_PRERELEASE=$(echo "$RELEASE_DATA" | jq -r '.prerelease')
          HTML_URL=$(echo "$RELEASE_DATA" | jq -r '.html_url')
          
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "html_url=$HTML_URL" >> $GITHUB_OUTPUT
          
      - name: Check if already exists
        id: check_tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh release view ${{ steps.upstream.outputs.tag_name }} >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag ${{ steps.upstream.outputs.tag_name }} 已经存在，跳过构建。"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Go
        if: steps.check_tag.outputs.exists == 'false'
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.7"

      - name: Build
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          git clone --depth 1 --branch ${{ steps.upstream.outputs.tag_name }} https://github.com/SagerNet/sing-box.git source
          cd source
          go build -v -tags "with_quic with_dhcp with_wireguard with_utls with_acme with_v2ray_api with_gvisor with_tailscale" ./cmd/sing-box
          mv sing-box ../

      - name: Create Release
        if: steps.check_tag.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.upstream.outputs.tag_name }}"
          PRERELEASE_FLAG=""
          if [ "${{ steps.upstream.outputs.is_prerelease }}" = "true" ]; then
            PRERELEASE_FLAG="--prerelease"
          fi
          
          gh release create "$TAG" \
            ./sing-box \
            --title "$TAG" \
            --notes "Upstream Release: ${{ steps.upstream.outputs.html_url }}" \
            $PRERELEASE_FLAG
